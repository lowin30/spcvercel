{
  "name": "SPC Chatbot Pro - HTTP API",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "spc-chatbot",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 400],
      "webhookId": "spc-chatbot-pro"
    },
    {
      "parameters": {
        "jsCode": "// Extraer y validar datos del request\nconst body = $input.item.json.body || $input.item.json;\n\n// Datos del usuario\nconst userMessage = body.message || body.chatInput || '';\nconst sessionId = body.sessionId || body.session || `session-${Date.now()}`;\nconst userId = body.userId || 'f1d219b3-c118-476d-a0f4-fec17da668b5';\nconst userName = body.userName || 'Usuario Demo';\nconst userRole = body.userRole || 'supervisor';\n\n// ValidaciÃ³n\nif (!userMessage || userMessage.trim() === '') {\n  throw new Error('Mensaje vacÃ­o');\n}\n\nreturn {\n  json: {\n    userId: userId,\n    userName: userName,\n    userRole: userRole,\n    userMessage: userMessage.trim(),\n    timestamp: new Date().toISOString(),\n    sessionId: sessionId,\n    // Para Supabase REST API\n    supabase_url: 'https://fodyzgjwoccpsjmfinvm.supabase.co',\n    service_role_key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvZHl6Z2p3b2NjcHNqbWZpbnZtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcxNjE4NTE0OCwiZXhwIjoyMDMxNzYxMTQ4fQ.1OIkRlqo_BJ4emSa1n_GCOe7jK5FQlsn1OsO73xFxZw'\n  }\n};"
      },
      "id": "context",
      "name": "Preparar Contexto",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 400]
    },
    {
      "parameters": {
        "url": "={{ $json.supabase_url }}/rest/v1/rpc/count_tareas_pendientes",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $json.service_role_key }}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.service_role_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "p_user_id",
              "value": "={{ $json.userId }}"
            },
            {
              "name": "p_user_role",
              "value": "={{ $json.userRole }}"
            }
          ]
        },
        "options": {}
      },
      "id": "count-tareas",
      "name": "Contar Tareas",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [680, 400]
    },
    {
      "parameters": {
        "jsCode": "// Construir respuesta inteligente\nconst userMessage = $('Preparar Contexto').item.json.userMessage.toLowerCase();\nconst userRole = $('Preparar Contexto').item.json.userRole;\nconst userName = $('Preparar Contexto').item.json.userName;\nconst sessionId = $('Preparar Contexto').item.json.sessionId;\n\nconst tareasTotal = $json.count || 0;\n\nlet response = '';\n\n// DetecciÃ³n de intenciÃ³n\nif (userMessage.includes('hola') || userMessage.includes('hey') || userMessage.includes('buenas')) {\n  response = `Â¡Hola ${userName}! ðŸ‘‹ Soy tu asistente inteligente de SPC.\\n\\n`;\n  response += `Puedo ayudarte con:\\n`;\n  response += `ðŸ“‹ Consultar tareas pendientes\\n`;\n  \n  if (userRole === 'supervisor' || userRole === 'admin') {\n    response += `ðŸ’° Revisar gastos y liquidaciones\\n`;\n  }\n  \n  response += `ðŸ¢ Estado de edificios\\n`;\n  response += `ðŸ“Š Generar resÃºmenes\\n\\n`;\n  response += `Â¿En quÃ© te puedo ayudar hoy?`;\n  \n} else if (userMessage.includes('tarea') || userMessage.includes('pendiente') || userMessage.includes('trabajo')) {\n  \n  if (tareasTotal === 0) {\n    response = `âœ… Â¡Excelente trabajo! No tienes tareas pendientes en este momento.`;\n  } else if (tareasTotal === 1) {\n    response = `ðŸ“‹ Tienes **1 tarea pendiente** que requiere tu atenciÃ³n.`;\n  } else {\n    response = `ðŸ“‹ Tienes **${tareasTotal} tareas pendientes**.`;\n  }\n  \n  if (userRole === 'supervisor') {\n    response += `\\n\\nðŸ’¼ Como supervisor, estas son las tareas bajo tu supervisiÃ³n.`;\n  } else if (userRole === 'trabajador') {\n    response += `\\n\\nðŸ‘· Estas son las tareas donde estÃ¡s asignado.`;\n  } else if (userRole === 'admin') {\n    response += `\\n\\nðŸ‘‘ Como administrador, tienes visibilidad total del sistema.`;\n  }\n  \n  if (tareasTotal > 0) {\n    response += `\\n\\nÂ¿Quieres que te muestre mÃ¡s detalles?`;\n  }\n  \n} else if (userMessage.includes('resumen') || userMessage.includes('estado') || userMessage.includes('overview')) {\n  \n  response = `ðŸ“Š **Resumen SPC**\\n\\n`;\n  response += `ðŸ‘¤ Usuario: ${userName}\\n`;\n  response += `ðŸŽ­ Rol: ${userRole}\\n`;\n  response += `ðŸ“‹ Tareas pendientes: **${tareasTotal}**\\n`;\n  response += `ðŸ• Ãšltima actualizaciÃ³n: ${new Date().toLocaleTimeString('es-AR')}\\n\\n`;\n  \n  if (tareasTotal > 5) {\n    response += `âš ï¸ Tienes varias tareas acumuladas. Â¿Necesitas priorizarlas?`;\n  } else if (tareasTotal > 0) {\n    response += `âœ… Volumen de trabajo manejable.`;\n  } else {\n    response += `ðŸŽ‰ Â¡Todo al dÃ­a!`;\n  }\n  \n} else if (userMessage.includes('ayuda') || userMessage.includes('help') || userMessage.includes('quÃ© puedes')) {\n  \n  response = `ðŸ’¡ **GuÃ­a RÃ¡pida**\\n\\n`;\n  response += `Puedo ayudarte con:\\n\\n`;\n  response += `ðŸ“‹ **Tareas**\\n`;\n  response += `   â€¢ \"Â¿CuÃ¡ntas tareas tengo?\"\\n`;\n  response += `   â€¢ \"MuÃ©strame mis pendientes\"\\n\\n`;\n  \n  if (userRole !== 'trabajador') {\n    response += `ðŸ’° **Finanzas**\\n`;\n    response += `   â€¢ \"Gastos sin liquidar\"\\n`;\n    response += `   â€¢ \"Resumen de liquidaciones\"\\n\\n`;\n  }\n  \n  response += `ðŸ“Š **Reportes**\\n`;\n  response += `   â€¢ \"Dame un resumen\"\\n`;\n  response += `   â€¢ \"Estado general\"\\n\\n`;\n  response += `Â¿QuÃ© necesitas consultar?`;\n  \n} else {\n  // Respuesta por defecto con contexto\n  response = `Entiendo que preguntas sobre: \"${$('Preparar Contexto').item.json.userMessage}\"\\n\\n`;\n  response += `ðŸ“Š **InformaciÃ³n disponible:**\\n`;\n  response += `â€¢ Tareas pendientes: **${tareasTotal}**\\n\\n`;\n  \n  response += `ðŸ’¡ Puedes preguntarme cosas como:\\n`;\n  response += `â€¢ \"Â¿CuÃ¡ntas tareas tengo?\"\\n`;\n  response += `â€¢ \"Dame un resumen\"\\n`;\n  \n  if (userRole !== 'trabajador') {\n    response += `â€¢ \"Gastos sin liquidar\"\\n`;\n  }\n}\n\nreturn {\n  json: {\n    response: response,\n    tareas_pendientes: tareasTotal,\n    timestamp: new Date().toISOString(),\n    session_id: sessionId,\n    user_role: userRole\n  }\n};"
      },
      "id": "generate-response",
      "name": "Generar Respuesta IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400]
    },
    {
      "parameters": {
        "url": "={{ $('Preparar Contexto').item.json.supabase_url }}/rest/v1/chat_messages",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Preparar Contexto').item.json.service_role_key }}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Preparar Contexto').item.json.service_role_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"conversation_id\": $('Preparar Contexto').item.json.sessionId,\n  \"role\": \"user\",\n  \"content\": $('Preparar Contexto').item.json.userMessage\n} }}",
        "options": {}
      },
      "id": "save-user-msg",
      "name": "Guardar Mensaje Usuario",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [680, 200]
    },
    {
      "parameters": {
        "url": "={{ $('Preparar Contexto').item.json.supabase_url }}/rest/v1/chat_messages",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Preparar Contexto').item.json.service_role_key }}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Preparar Contexto').item.json.service_role_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"conversation_id\": $json.session_id,\n  \"role\": \"assistant\",\n  \"content\": $json.response,\n  \"model\": \"rule-based-v2\"\n} }}",
        "options": {}
      },
      "id": "save-ai-msg",
      "name": "Guardar Respuesta IA",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": true,\n  \"response\": $json.response,\n  \"tareas_pendientes\": $('Generar Respuesta IA').item.json.tareas_pendientes,\n  \"timestamp\": $json.timestamp,\n  \"session_id\": $json.session_id\n} }}",
        "options": {}
      },
      "id": "respond",
      "name": "Responder",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1340, 400]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Preparar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Contexto": {
      "main": [
        [
          {
            "node": "Contar Tareas",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guardar Mensaje Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Contar Tareas": {
      "main": [
        [
          {
            "node": "Generar Respuesta IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar Respuesta IA": {
      "main": [
        [
          {
            "node": "Guardar Respuesta IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Respuesta IA": {
      "main": [
        [
          {
            "node": "Responder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": []
}
